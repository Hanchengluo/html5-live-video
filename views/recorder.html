<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <title>Recorder</title>
    <link rel="stylesheet" href="styles.css" type="text/css" media="screen" charset="utf-8">
</head>
<body>
    <div class="left">
        <video autoplay id="sourcevid" class="size"></video>
    </div>

    <div class="right">
        <canvas id="output" class="size"></canvas>
    </div>

    <div class="left">
        <img id="displayer"/>
    </div>

    <script type="text/javascript" charset="utf-8">
        var socket = new WebSocket("ws://192.168.0.100:8080/");
        var acceptor_socket = new WebSocket("ws://192.168.0.100:8008/");
        var back = document.createElement('canvas');
        var backcontext = back.getContext('2d');
        var image = document.getElementById('displayer');
        acceptor_socket.onopen = function(){ console.log("connected"); }
        acceptor_socket.onmessage = function(data)
        {
            image.src=data.data;
        }

        var back = document.getElementById('output');
        var backcontext = back.getContext('2d');
        var video = document.getElementsByTagName('video')[0];
        socket.onopen = function(){ console.log("connected"); }

        var send=function(message)
        {
            if(socket.readyState===1)
            {
                socket.send(message);
            }
            else
            {
                console.log("Error: "+socket.readyState);
            }
        }

        var failure = function(error){ console.log(error); }

        var globalStream;

        var success = function(stream)
        {
            video.src=window.webkitURL.createObjectURL(stream);
            globalStream=stream;
        }

        var draw = function()
        {
            backcontext.drawImage(video,0,0, back.width, back.height);
            var stringData= back.toDataURL();
            send(stringData);
            console.log(socket.readyState);
            setTimeout(draw, 0);
        }

        navigator.webkitGetUserMedia({video:true, audio:false}, success, failure);
        draw();
    </script>
</body>
</html>
